commit d108b14364149602f08f0530c2edc71352629ddf
Author: Lukasz Wesierski <lukasz.wesierski@intel.com>
Date:   Wed Sep 16 06:51:28 2020 -0700

    Fix building for LLVM11 (next part)
    
    Change-Id: Ibcdc80e6c32515f80f1e2957e0675be84c464a62

diff --git a/IGC/AdaptorCommon/AddImplicitArgs.cpp b/IGC/AdaptorCommon/AddImplicitArgs.cpp
index 244a9074..56a02797 100644
--- a/IGC/AdaptorCommon/AddImplicitArgs.cpp
+++ b/IGC/AdaptorCommon/AddImplicitArgs.cpp
@@ -614,7 +614,13 @@ void BuiltinCallGraphAnalysis::traveseCallGraphSCC(const std::vector<CallGraphNo
             if (argMapIter != argMap.end())
             {
                 IGC_ASSERT(nullptr != argMapIter->second);
-                combineTwoArgDetail(*argData, *(argMapIter->second), N.first);
+                combineTwoArgDetail(*argData, *(argMapIter->second), 
+#if LLVM_VERSION_MAJOR <= 10
+                    N.first
+#else
+                    *N.first
+#endif
+                    );
             }
         }
     }
diff --git a/IGC/AdaptorCommon/LegalizeFunctionSignatures.cpp b/IGC/AdaptorCommon/LegalizeFunctionSignatures.cpp
index 2d492f43..30ceb4f7 100644
--- a/IGC/AdaptorCommon/LegalizeFunctionSignatures.cpp
+++ b/IGC/AdaptorCommon/LegalizeFunctionSignatures.cpp
@@ -63,7 +63,7 @@ LegalizeFunctionSignatures::LegalizeFunctionSignatures()
 
 bool LegalizeFunctionSignatures::runOnModule(Module& M)
 {
-    llvm::IRBuilder<> builder(M.getContext());
+    IGCLLVM::IRBuilder<> builder(M.getContext());
     m_pBuilder = &builder;
     m_pContext = getAnalysis<CodeGenContextWrapper>().getCodeGenContext();
     m_pMdUtils = getAnalysis<MetaDataUtilsWrapper>().getMetaDataUtils();
diff --git a/IGC/AdaptorCommon/LegalizeFunctionSignatures.h b/IGC/AdaptorCommon/LegalizeFunctionSignatures.h
index b5cf3c09..36066119 100644
--- a/IGC/AdaptorCommon/LegalizeFunctionSignatures.h
+++ b/IGC/AdaptorCommon/LegalizeFunctionSignatures.h
@@ -31,7 +31,7 @@ SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
 #include "common/LLVMWarningsPush.hpp"
 #include <llvm/Pass.h>
 #include <llvm/IR/InstVisitor.h>
-#include <llvm/IR/IRBuilder.h>
+#include <llvmWrapper/IR/IRBuilder.h>
 #include "common/LLVMWarningsPop.hpp"
 
 #include <map>
@@ -70,7 +70,7 @@ public:
 private:
     IGC::CodeGenContext* m_pContext;
     IGC::IGCMD::MetaDataUtils* m_pMdUtils;
-    llvm::IRBuilder<>* m_pBuilder;
+    IGCLLVM::IRBuilder<>* m_pBuilder;
     llvm::Module* m_pModule;
 
     bool m_funcSignatureChanged;
diff --git a/IGC/AdaptorCommon/ProcessFuncAttributes.cpp b/IGC/AdaptorCommon/ProcessFuncAttributes.cpp
index 29abc9a6..2e0cfc8f 100644
--- a/IGC/AdaptorCommon/ProcessFuncAttributes.cpp
+++ b/IGC/AdaptorCommon/ProcessFuncAttributes.cpp
@@ -617,7 +617,7 @@ void ProcessBuiltinMetaData::updateBuiltinFunctionMetaData(llvm::Function* pFunc
         llvm::raw_string_ostream x(typeStr);
         arg->getType()->print(x);
 
-        funcMD->m_OpenCLArgNames.push_back(arg->getName());
+        funcMD->m_OpenCLArgNames.push_back(arg->getName().str());
         funcMD->m_OpenCLArgAccessQualifiers.push_back("none");
         funcMD->m_OpenCLArgBaseTypes.push_back(x.str());
     }
diff --git a/IGC/AdaptorOCL/SPIRV/SPIRVReader.cpp b/IGC/AdaptorOCL/SPIRV/SPIRVReader.cpp
index 4aedb692..785dd3ae 100644
--- a/IGC/AdaptorOCL/SPIRV/SPIRVReader.cpp
+++ b/IGC/AdaptorOCL/SPIRV/SPIRVReader.cpp
@@ -69,6 +69,7 @@ SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
 #include "llvmWrapper/IR/DIBuilder.h"
 #include "llvmWrapper/IR/Module.h"
 #include "llvmWrapper/Support/Alignment.h"
+#include "llvmWrapper/Support/TypeSize.h"
 
 #include <llvm/Support/ScaledNumber.h>
 #include <llvm/IR/LegacyPassManager.h>
@@ -2168,7 +2169,7 @@ SPIRVToLLVM::postProcessFunctionsReturnStruct(Function *F) {
   if (!F->getReturnType()->isStructTy())
     return false;
 
-  std::string Name = F->getName();
+  std::string Name = F->getName().str();
   F->setName(Name + ".old");
 
   std::vector<Type *> ArgTys;
@@ -2214,7 +2215,11 @@ SPIRVToLLVM::postProcessFunctionsReturnStruct(Function *F) {
       Args.insert(Args.begin(), Alloca);
       auto NewCI = CallInst::Create(NewF, Args, "", CI);
       NewCI->setCallingConv(CI->getCallingConv());
-      auto Load = new LoadInst(Alloca,"",CI);
+      auto Load = new LoadInst(
+#if LLVM_VERSION_MAJOR > 7
+      Alloca->getType()->getPointerElementType(),
+#endif
+      Alloca,"",CI);
       CI->replaceAllUsesWith(Load);
       CI->eraseFromParent();
     }
@@ -2231,7 +2236,8 @@ SPIRVToLLVM::postProcessFunctionsWithAggregateArguments(Function* F) {
   auto DL = M->getDataLayout();
   auto ptrSize = DL.getPointerSize();
 
-  mutateFunction (F, [=](CallInst *CI, std::vector<Value *> &Args) {
+  mutateFunction (F,
+      [=](CallInst *CI, std::vector<Value *> &Args) {
     auto FBegin = CI->getParent()->getParent()->begin()->getFirstInsertionPt();
     IGCLLVM::IRBuilder<> builder(&(*FBegin));
 
@@ -2266,7 +2272,7 @@ SPIRVToLLVM::postProcessFunctionsWithAggregateArguments(Function* F) {
         llvm_unreachable("Unknown aggregate type!");
       }
     }
-    return Name;
+    return Name.str();
   }, false, &Attrs);
   return true;
 }
@@ -2747,7 +2753,12 @@ SPIRVToLLVM::transValueWithoutDecoration(SPIRVValue *BV, Function *F,
         nullptr,
         std::string(kPlaceholderPrefix) + BV->getName(),
         0, GlobalVariable::NotThreadLocal, 0);
-    auto LD = new LoadInst(GV, BV->getName(), BB);
+
+    auto LD = new LoadInst(
+#if LLVM_VERSION_MAJOR > 7
+      GV->getType()->getPointerElementType(),
+#endif
+      GV, BV->getName(), BB);
     PlaceholderMap[BV] = LD;
     return mapValue(BV, LD);
   }
@@ -2886,8 +2897,12 @@ SPIRVToLLVM::transValueWithoutDecoration(SPIRVValue *BV, Function *F,
   case OpLoad: {
     SPIRVLoad *BL = static_cast<SPIRVLoad*>(BV);
     IGC_ASSERT_MESSAGE(BB, "Invalid BB");
+    auto val = transValue(BL->getSrc(), F, BB);
     return mapValue(BV, new LoadInst(
-      transValue(BL->getSrc(), F, BB),
+#if LLVM_VERSION_MAJOR > 7
+      val->getType()->getPointerElementType(),
+#endif
+      val,
       BV->getName(),
       BL->hasDecorate(DecorationVolatile) || BL->SPIRVMemoryAccess::getVolatile() != 0,
       IGCLLVM::getCorrectAlign(BL->SPIRVMemoryAccess::getAlignment()),
@@ -3129,9 +3144,16 @@ SPIRVToLLVM::transValueWithoutDecoration(SPIRVValue *BV, Function *F,
   case OpFunctionPointerCallINTEL: {
     SPIRVFunctionPointerCallINTEL *BC =
       static_cast<SPIRVFunctionPointerCallINTEL*>(BV);
-    auto Call = CallInst::Create(transValue(BC->getCalledValue(), F, BB),
-      transValue(BC->getArgumentValues(), F, BB),
-      BC->getName(), BB);
+    auto func = transValue(BC->getCalledValue(), F, BB);
+    auto Call = CallInst::Create(
+#if LLVM_VERSION_MAJOR > 7
+        llvm::cast<llvm::FunctionType>(
+            llvm::cast<llvm::PointerType>(func->getType())->getElementType()),
+#endif
+        func,
+        transValue(BC->getArgumentValues(), F, BB),
+        BC->getName(), 
+        BB);
     // Assuming we are calling a regular device function
     Call->setCallingConv(CallingConv::SPIR_FUNC);
     // Don't set attributes, because at translation time we don't know which
@@ -3153,7 +3175,13 @@ SPIRVToLLVM::transValueWithoutDecoration(SPIRVValue *BV, Function *F,
 
   case OpFNegate: {
     SPIRVUnary *BC = static_cast<SPIRVUnary*>(BV);
-    return mapValue(BV, BinaryOperator::CreateFNeg(
+    return mapValue(BV, 
+#if LLVM_VERSION_MAJOR <= 10
+        BinaryOperator
+#else
+        UnaryOperator
+#endif
+        ::CreateFNeg(
       transValue(BC->getOperand(0), F, BB),
       BV->getName(), BB));
     }
@@ -3229,7 +3257,8 @@ SPIRVToLLVM::transValueWithoutDecoration(SPIRVValue *BV, Function *F,
           a->getType()->getScalarType(),
           a->getType()->getScalarSizeInBits() - 1);
       auto *ShiftOp = isa<VectorType>(a->getType()) ?
-          ConstantVector::getSplat((unsigned)cast<VectorType>(a->getType())->getNumElements(), ShiftAmt) :
+          ConstantVector::getSplat(
+              IGCLLVM::getElementCount((unsigned)cast<VectorType>(a->getType())->getNumElements()), ShiftAmt) :
           ShiftAmt;
 
       // OCL C:
diff --git a/IGC/AdaptorOCL/SPIRV/SPIRVUtil.cpp b/IGC/AdaptorOCL/SPIRV/SPIRVUtil.cpp
index 534d66fd..10773e62 100644
--- a/IGC/AdaptorOCL/SPIRV/SPIRVUtil.cpp
+++ b/IGC/AdaptorOCL/SPIRV/SPIRVUtil.cpp
@@ -65,6 +65,7 @@ SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
 
 #include "common/LLVMWarningsPush.hpp"
 
+#include "llvmWrapper/IR/DerivedTypes.h"
 #include "llvmWrapper/Bitcode/BitcodeWriter.h"
 #include "llvmWrapper/IR/Attributes.h"
 #include "llvmWrapper/Support/ToolOutputFile.h"
@@ -157,7 +158,7 @@ std::string recursive_mangle(const Type* pType)
             return "f16";
         case Type::IntegerTyID:
             return "i" + utostr(pType->getIntegerBitWidth());
-        case Type::VectorTyID:
+        case IGCLLVM::VectorTyID:
         {
             unsigned vecLen = (unsigned)cast<VectorType>(pType)->getNumElements();
             Type* pEltType = cast<VectorType>(pType)->getElementType();
@@ -177,7 +178,7 @@ std::string recursive_mangle(const Type* pType)
         }
         case Type::StructTyID:
         {
-            auto structName = cast<StructType>(pType)->getName();
+            auto structName = cast<StructType>(pType)->getName().str();
             auto pointPos = structName.rfind('.');
             return pointPos != structName.npos ? structName.substr(pointPos + 1) : structName;
         }
@@ -310,7 +311,7 @@ mutateCallInst(Module *M, CallInst *CI,
   auto NewName = ArgMutate(CI, Args);
   std::string InstName;
   if (!CI->getType()->isVoidTy() && CI->hasName()) {
-    InstName = CI->getName();
+    InstName = CI->getName().str();
     CI->setName(InstName + ".old");
   }
 
@@ -331,7 +332,7 @@ mutateCallInst(Module *M, CallInst *CI,
     IRBuilder<> builder(EntryBB);
 
     for (auto OldArgIt = OldF->arg_begin(), NewArgIt = NewF->arg_begin(); OldArgIt != OldF->arg_end(); ++OldArgIt, ++NewArgIt) {
-      NewArgIt->setName(OldArgIt->getName());
+      NewArgIt->setName(OldArgIt->getName().str());
       if (OldArgIt->getType() == NewArgIt->getType()) {
         VMap[&*OldArgIt] = &*NewArgIt;
       }
diff --git a/IGC/AdaptorOCL/dllInterfaceCompute.cpp b/IGC/AdaptorOCL/dllInterfaceCompute.cpp
index 52d12869..534767da 100644
--- a/IGC/AdaptorOCL/dllInterfaceCompute.cpp
+++ b/IGC/AdaptorOCL/dllInterfaceCompute.cpp
@@ -451,7 +451,7 @@ bool ProcessElfInput(
               llvm::Module* pKernelModule = nullptr;
 #if defined(IGC_SPIRV_ENABLED)
               Context.setAsSPIRV();
-              std::istringstream IS(buf);
+              std::istringstream IS(buf.str());
               std::string stringErrMsg;
               std::unordered_map<uint32_t, uint64_t> specIDToSpecValueMap = UnpackSpecConstants(
                                                                                   InputArgs.pSpecConstantsIds,
@@ -698,7 +698,7 @@ bool ParseInput(
     else if (inputDataFormatTemp == TB_DATA_FORMAT_SPIR_V) {
 #if defined(IGC_SPIRV_ENABLED)
         //convert SPIR-V binary to LLVM module
-        std::istringstream IS(strInput);
+        std::istringstream IS(strInput.str());
         std::string stringErrMsg;
         std::unordered_map<uint32_t, uint64_t> specIDToSpecValueMap = UnpackSpecConstants(
                                                                             pInputArgs->pSpecConstantsIds,
diff --git a/IGC/Compiler/CISACodeGen/OpenCLKernelCodeGen.cpp b/IGC/Compiler/CISACodeGen/OpenCLKernelCodeGen.cpp
index 4dc92312..66fdf4ea 100644
--- a/IGC/Compiler/CISACodeGen/OpenCLKernelCodeGen.cpp
+++ b/IGC/Compiler/CISACodeGen/OpenCLKernelCodeGen.cpp
@@ -2075,7 +2075,7 @@ namespace IGC
             {
                 ctx->m_programOutput.m_ShaderProgramList.push_back(pKernel);
             }
-            COMPILER_SHADER_STATS_PRINT(pKernel->m_shaderStats, ShaderType::OPENCL_SHADER, ctx->hash, pFunc->getName());
+            COMPILER_SHADER_STATS_PRINT(pKernel->m_shaderStats, ShaderType::OPENCL_SHADER, ctx->hash, pFunc->getName().str());
             COMPILER_SHADER_STATS_SUM(ctx->m_sumShaderStats, pKernel->m_shaderStats, ShaderType::OPENCL_SHADER);
             COMPILER_SHADER_STATS_DEL(pKernel->m_shaderStats);
         }
diff --git a/IGC/WrapperLLVM/include/llvmWrapper/IR/DIBuilder.h b/IGC/WrapperLLVM/include/llvmWrapper/IR/DIBuilder.h
index ed6a1f7e..a4b76464 100644
--- a/IGC/WrapperLLVM/include/llvmWrapper/IR/DIBuilder.h
+++ b/IGC/WrapperLLVM/include/llvmWrapper/IR/DIBuilder.h
@@ -129,6 +129,31 @@ namespace IGCLLVM
 #elif LLVM_VERSION_MAJOR >= 8
                 Scope, Name, LinkageName, File, LineNo, Ty, ScopeLine,
                 Flags, llvm::DISubprogram::SPFlagDefinition, TParams, Decl, ThrownTypes);
+#endif
+        }
+
+        inline llvm::DITemplateTypeParameter* createTemplateTypeParameter(
+            llvm::DIScope* Scope,
+            llvm::StringRef Name,
+            llvm::DIType* Ty)
+        {
+#if LLVM_VERSION_MAJOR <= 10
+            return llvm::DIBuilder::createTemplateTypeParameter(Scope, Name, Ty);
+#else
+            return llvm::DIBuilder::createTemplateTypeParameter(Scope, Name, Ty, true);
+#endif
+        }
+
+        inline llvm::DITemplateValueParameter* createTemplateValueParameter(
+            llvm::DIScope* Scope,
+            llvm::StringRef Name,
+            llvm::DIType* Ty,
+            llvm::Constant* Val)
+        {
+#if LLVM_VERSION_MAJOR <= 10
+            return llvm::DIBuilder::createTemplateValueParameter(Scope, Name, Ty, Val);
+#else
+            return llvm::DIBuilder::createTemplateValueParameter(Scope, Name, Ty, true, Val);
 #endif
         }
     };
diff --git a/IGC/WrapperLLVM/include/llvmWrapper/IR/IRBuilder.h b/IGC/WrapperLLVM/include/llvmWrapper/IR/IRBuilder.h
index df02d03d..d4afe522 100644
--- a/IGC/WrapperLLVM/include/llvmWrapper/IR/IRBuilder.h
+++ b/IGC/WrapperLLVM/include/llvmWrapper/IR/IRBuilder.h
@@ -256,6 +256,34 @@ namespace IGCLLVM
         }
 #endif
 
+        inline llvm::Value* CreateConstInBoundsGEP2_64(
+            llvm::Value* Ptr,
+            uint64_t Idx0,
+            uint64_t Idx1,
+            const llvm::Twine& Name = "")
+        {
+#if LLVM_VERSION_MAJOR <= 10
+            return llvm::IRBuilder<T, InserterTyDef()>::CreateConstInBoundsGEP2_64(Ptr, Idx0, Idx1, Name);
+#else
+            return llvm::IRBuilder<T, InserterTyDef()>::CreateConstInBoundsGEP2_64(Ptr->getType()->getPointerElementType(), Ptr, Idx0, Idx1, Name);
+#endif
+        }
+
+        inline static llvm::CallInst* Create(llvm::Value* Func, llvm::ArrayRef<llvm::Value*> Args,
+            llvm::ArrayRef<llvm::OperandBundleDef> Bundles = llvm::None,
+            const llvm::Twine& NameStr = "",
+            llvm::Instruction* InsertBefore = nullptr)
+        {
+#if LLVM_VERSION_MAJOR <= 7
+            return llvm::IRBuilder<T, InserterTyDef()>::Create(
+                Func, Args, Bundles, NameStr, InsertBefore);
+#else
+            return llvm::IRBuilder<T, InserterTyDef()>::Create(llvm::cast<llvm::FunctionType>(
+                llvm::cast<llvm::PointerType>(Func->getType())->getElementType()),
+                Func, Args, Bundles, NameStr, InsertBefore);
+#endif
+        }
+
     };
 #endif
 }
diff --git a/IGC/common/FunctionUpgrader.h b/IGC/common/FunctionUpgrader.h
index df827c37..82b746bc 100644
--- a/IGC/common/FunctionUpgrader.h
+++ b/IGC/common/FunctionUpgrader.h
@@ -27,6 +27,7 @@ SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
 #pragma once
 
 #include "common/LLVMWarningsPush.hpp"
+#include <llvm/IR/Instructions.h>
 #include <llvm/IR/Function.h>
 #include <llvm/IR/Type.h>
 #include <llvm/Transforms/Utils/ValueMapper.h>
diff --git a/IGC/common/debug/Dump.cpp b/IGC/common/debug/Dump.cpp
index f7928ab9..9c2e06fe 100644
--- a/IGC/common/debug/Dump.cpp
+++ b/IGC/common/debug/Dump.cpp
@@ -721,7 +721,7 @@ DumpName GetDumpNameObj(IGC::CShader* pProgram, const char* ext)
 
     if(pProgram->entry->getName() != "entry")
     {
-        dumpName = dumpName.PostFix(pProgram->entry->getName());
+        dumpName = dumpName.PostFix(pProgram->entry->getName().str());
     }
     if (pProgram->GetShaderType() == ShaderType::PIXEL_SHADER)
     {
